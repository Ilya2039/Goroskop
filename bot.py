import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
import sqlite3
import json  # –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Web App
from google import genai
import requests
import logging
# from googletrans import Translator
from datetime import datetime
# from google.cloud import translate_v2 as translate
from translatepy import Translator
import time

# üîπ –ù–∞—Å—Ç—Ä–æ–π–∫–∏
API_TOKEN = '7582972873:AAGX0VJea8BdfGpV_QLvU3sBtXZi9L-xNrw'
TAROT_APP_URL = 'https://e04c-169-150-209-163.ngrok-free.app/tarot/'
NATAL_APP_URL = 'https://e04c-169-150-209-163.ngrok-free.app/natal/'
flask_url = "https://e04c-169-150-209-163.ngrok-free.app/horoscope/today"
GEMINI_API_KEY = "AIzaSyCqE4taBEs1GJUh_pJQUqdGgcSEfGL8Pbc"

# üîπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ Gemini API
bot = telebot.TeleBot(API_TOKEN)
gemini_client = genai.Client(api_key=GEMINI_API_KEY)
translator = Translator()

# üîπ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.DEBUG)

# üîπ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite
DB_NAME = "users.db"

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL UNIQUE,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            date_added TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)
    conn.commit()
    conn.close()

def add_user(user_id, username, first_name, last_name):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    try:
        cursor.execute("""
            INSERT INTO users (user_id, username, first_name, last_name)
            VALUES (?, ?, ?, ?)
        """, (user_id, username, first_name, last_name))
        conn.commit()
    except sqlite3.IntegrityError:
        pass  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    
    conn.close()

# üîπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
init_db()

# üîπ –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def start_command(message):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    user_id = message.from_user.id
    username = message.from_user.username
    first_name = message.from_user.first_name
    last_name = message.from_user.last_name

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    add_user(user_id, username, first_name, last_name)

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton("üîÆ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ", web_app=WebAppInfo(url=TAROT_APP_URL)))
    keyboard.add(InlineKeyboardButton("üåå –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É", web_app=WebAppInfo(url=NATAL_APP_URL)))
    keyboard.add(InlineKeyboardButton("‚ú® –ì–æ—Ä–æ—Å–∫–æ–ø", callback_data="horoscope"))
    keyboard.add(InlineKeyboardButton("‚ú® –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –¢–∞—Ä–æ–ª–æ–≥–∞", callback_data="consultation"))

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    bot.send_message(
        chat_id=message.chat.id,
        text="–ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å:",
        reply_markup=keyboard
    )

'''# üîπ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ì–æ—Ä–æ—Å–∫–æ–ø"
@bot.callback_query_handler(func=lambda call: call.data == "horoscope")
def horoscope_menu(call):
    """–ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞"""
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton("üåû –î–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø", callback_data="daily_horoscope"))
    keyboard.add(InlineKeyboardButton("‚ù§Ô∏è –õ—é–±–æ–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø", callback_data="love_horoscope"))
    keyboard.add(InlineKeyboardButton("üíº –ö–∞—Ä—å–µ—Ä–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø", callback_data="career_horoscope"))

    bot.edit_message_text(
        chat_id=call.message.chat.id,
        message_id=call.message.message_id,
        text="–ö–∞–∫–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø —Ö–æ—Ç–∏—Ç–µ?",
        reply_markup=keyboard
    )'''

zodiac_translation = {
    "–û–≤–µ–Ω": "Aries", "–¢–µ–ª–µ—Ü": "Taurus", "–ë–ª–∏–∑–Ω–µ—Ü—ã": "Gemini", "–†–∞–∫": "Cancer",
    "–õ–µ–≤": "Leo", "–î–µ–≤–∞": "Virgo", "–í–µ—Å—ã": "Libra", "–°–∫–æ—Ä–ø–∏–æ–Ω": "Scorpio",
    "–°—Ç—Ä–µ–ª–µ—Ü": "Sagittarius", "–ö–æ–∑–µ—Ä–æ–≥": "Capricorn", "–í–æ–¥–æ–ª–µ–π": "Aquarius", "–†—ã–±—ã": "Pisces"
}

# üîπ –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
@bot.callback_query_handler(func=lambda call: call.data == "horoscope")
def horoscope_menu(call):
    """–ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞"""
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton("üåû –î–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø", callback_data="daily_horoscope"))
    keyboard.add(InlineKeyboardButton("‚ù§Ô∏è –õ—é–±–æ–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø", callback_data="love_horoscope"))
    keyboard.add(InlineKeyboardButton("üíº –ö–∞—Ä—å–µ—Ä–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø", callback_data="career_horoscope"))

    bot.edit_message_text(
        chat_id=call.message.chat.id,
        message_id=call.message.message_id,
        text="–ö–∞–∫–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø —Ö–æ—Ç–∏—Ç–µ?",
        reply_markup=keyboard
    )

# üîπ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
@bot.callback_query_handler(func=lambda call: call.data in ["daily_horoscope", "love_horoscope", "career_horoscope"])
def select_zodiac(call):
    """–ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞"""
    horoscope_type_full = call.data  

    zodiac_signs = list(zodiac_translation.keys())

    keyboard = InlineKeyboardMarkup()
    for sign in zodiac_signs:
        keyboard.add(InlineKeyboardButton(sign, callback_data=f"{horoscope_type_full}_{sign}"))

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –≥–æ—Ä–æ—Å–∫–æ–ø–∞
    horoscope_texts_ru = {
        "daily_horoscope": "–¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø",
        "love_horoscope": "–ª—é–±–æ–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø",
        "career_horoscope": "–∫–∞—Ä—å–µ—Ä–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø"
    }
    display_text = horoscope_texts_ru.get(horoscope_type_full, "–≥–æ—Ä–æ—Å–∫–æ–ø")

    bot.edit_message_text(
        chat_id=call.message.chat.id,
        message_id=call.message.message_id,
        text=f"–í—ã –≤—ã–±—Ä–∞–ª–∏ {display_text}. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞:",
        reply_markup=keyboard
    )

# üîπ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ –∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ Gemini
@bot.callback_query_handler(func=lambda call: any(call.data.startswith(t) for t in ['daily_', 'love_', 'career_']))
def handle_zodiac_choice(call):
    user_id = call.message.chat.id
    type_full, zodiac_sign = call.data.rsplit('_', 1)
    horoscope_type = type_full.split('_')[0]  

    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∏–ø–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    horoscope_texts_ru = {
        'daily': '–¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø',
        'love': '–ª—é–±–æ–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø',
        'career': '–∫–∞—Ä—å–µ—Ä–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø'
    }

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
    if horoscope_type not in horoscope_texts_ru:
        bot.send_message(user_id, "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –≥–æ—Ä–æ—Å–∫–æ–ø–∞.")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ Gemini –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
    from datetime import datetime
    today_date = datetime.now().strftime("%Y-%m-%d")

    # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
    horoscope_prompts = {
        'daily': f"""
–î–∞–π –º–Ω–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫–∞ {zodiac_sign} –Ω–∞ {today_date}. –ù–µ –ø–∏—à–∏ –ø—Ä–æ –ª—é–±–æ–≤—å –∏ —Ä–∞–±–æ—Ç—É. –û—Ç–≤–µ—Ç –æ—Ñ–æ—Ä–º–∏ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

–ü—Ä–∏–º–µ—Ä:
–í–∞—à –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:

–°–µ–≥–æ–¥–Ω—è –∑–≤–µ–∑–¥—ã —Å–æ–≤–µ—Ç—É—é—Ç {zodiac_sign} –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω—ã –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –ø–ª–∞–Ω—ã. –î–µ–Ω—å –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–µ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π, –Ω–æ –∏–∑–±–µ–≥–∞–π—Ç–µ –ø–æ—Å–ø–µ—à–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.

–°–¥–µ–ª–∞–π –æ—Ç–≤–µ—Ç —á–µ—Ç–∫–∏–º, –ª–æ–≥–∏—á–Ω—ã–º –∏ –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤.
""",

        'love': f"""
–î–∞–π –º–Ω–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ª—é–±–æ–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫–∞ {zodiac_sign} –Ω–∞ {today_date}. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ —á—É–≤—Å—Ç–≤–∞—Ö, —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, –ª–∏—á–Ω–æ–π –∂–∏–∑–Ω–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –¥–ª—è –Ω–æ–≤—ã—Ö –∑–Ω–∞–∫–æ–º—Å—Ç–≤. –û—Ç–≤–µ—Ç –æ—Ñ–æ—Ä–º–∏ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

–ü—Ä–∏–º–µ—Ä:
–í–∞—à –ª—é–±–æ–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:

–°–µ–≥–æ–¥–Ω—è {zodiac_sign} –º–æ–∂–µ—Ç –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –æ—Å–æ–±—É—é —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–≤—è–∑—å —Å –±–ª–∏–∑–∫–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º. –ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —ç—Ç–æ—Ç –¥–µ–Ω—å –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è —Ç–µ–ø–ª–æ–≥–æ –æ–±—â–µ–Ω–∏—è –∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–∏–∑–Ω–∞–Ω–∏–π. –û–¥–∏–Ω–æ–∫–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏ –∑–Ω–∞–∫–∞ –º–æ–≥—É—Ç –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω–∏—Ç –∏—Ö –≤–∑–≥–ª—è–¥—ã –Ω–∞ –ª—é–±–æ–≤—å. –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —Å–≤–æ–µ —Å–µ—Ä–¥—Ü–µ.

–°–¥–µ–ª–∞–π –æ—Ç–≤–µ—Ç —á–µ—Ç–∫–∏–º, –ª–æ–≥–∏—á–Ω—ã–º –∏ –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤.
""",

        'career': f"""
–î–∞–π –º–Ω–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫–∞ {zodiac_sign} –Ω–∞ {today_date}. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö —Ä–∞–±–æ—Ç—ã, –±–∏–∑–Ω–µ—Å–∞, —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞. –û—Ç–≤–µ—Ç –æ—Ñ–æ—Ä–º–∏ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

–ü—Ä–∏–º–µ—Ä:
–í–∞—à –∫–∞—Ä—å–µ—Ä–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:

–°–µ–≥–æ–¥–Ω—è {zodiac_sign} –º–æ–∂–µ—Ç –æ–∂–∏–¥–∞—Ç—å –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –∫–∞—Ä—å–µ—Ä–µ. –í–∞–∂–Ω–æ –ø—Ä–æ—è–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ. –í–æ–∑–º–æ–∂–Ω–æ, –≤–∞–º –ø—Ä–∏–¥–µ—Ç—Å—è —Ä–µ—à–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –¥–æ—Å—Ç–∏—á—å —É—Å–ø–µ—Ö–∞. –í —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö –ª—É—á—à–µ –∏–∑–±–µ–≥–∞—Ç—å –Ω–µ–æ–±–¥—É–º–∞–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ –∫—Ä—É–ø–Ω—ã—Ö —Ç—Ä–∞—Ç.

–°–¥–µ–ª–∞–π –æ—Ç–≤–µ—Ç —á–µ—Ç–∫–∏–º, –ª–æ–≥–∏—á–Ω—ã–º –∏ –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤.
"""
    }

    # –í—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
    query_ru = horoscope_prompts[horoscope_type]

    logging.info(f"üì® –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Gemini: {query_ru}")

    try:
        # ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Gemini –Ω–∞–ø—Ä—è–º—É—é
        response = gemini_client.models.generate_content(
            model="gemini-2.0-flash-exp",
            contents=query_ru
        )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
        if hasattr(response, 'text') and response.text:
            horoscope_russian = response.text.strip()
            logging.info(f"‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Gemini: {horoscope_russian}")
        else:
            logging.error("‚ùå Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
            horoscope_russian = "–Ø –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø —Å–µ–π—á–∞—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

        # ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ Telegram
        bot.send_message(user_id, f"üîÆ {horoscope_russian}")

    except Exception as e:
        logging.exception(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≥–æ—Ä–æ—Å–∫–æ–ø–∞: {str(e)}")
        bot.send_message(user_id, "üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≥–æ—Ä–æ—Å–∫–æ–ø–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

user_queries = {}           # –î–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
conversation_context = {}

# ========= –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ =========
@bot.callback_query_handler(func=lambda call: call.data == "consultation")
def consultation_menu(call):
    """–ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"""
    user_id = call.message.chat.id

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
    bot.send_chat_action(user_id, action='typing')  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    bot.send_message(user_id, "‚åõ –ò—â—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞...")

    time.sleep(10)  # –≠–º—É–ª–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è
    bot.send_message(user_id, "‚úÖ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω–∞–π–¥–µ–Ω! –ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.")

    user_queries[user_id] = None  # –§–∏–∫—Å–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞

# ========= –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =========
@bot.message_handler(func=lambda message: message.chat.id in user_queries and user_queries[message.chat.id] is None)
def receive_user_query(message):
    user_id = message.chat.id
    query_text = message.text.strip() if message.text else ""
    
    if not query_text:
        bot.send_message(user_id, "‚ùå –í–∞—à –≤–æ–ø—Ä–æ—Å –ø—É—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_queries[user_id] = query_text

    bot.send_message(user_id, "‚åõ –ñ–¥–µ–º –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞...")
    bot.send_chat_action(user_id, action='typing')

    time.sleep(20)  # –°–∏–º—É–ª—è—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞

    system_prompt = (
    "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≥–∞–¥–∞–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–∞—Ö –¢–∞—Ä–æ. "
    "–¢—ã —Ç–æ–ª–∫—É–µ—à—å –∫–∞—Ä—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É—è —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã –∏ –≥–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è —ç–∑–æ—Ç–µ—Ä–∏–∫–∏. "
    "–ì–æ–≤–æ—Ä–∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ, —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø—Ä–æ —Å–≤–æ–±–æ–¥—É –≤–æ–ª–∏ –∏–ª–∏ —Ç–æ, —á—Ç–æ –∏—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. "
    "–ü–∏—à–∏, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –º–∏—Å—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —É–≤–µ—Ä–µ–Ω –≤ –ø—Ä–∞–≤–¥–∏–≤–æ—Å—Ç–∏ —Å–≤–æ–∏—Ö —Å–ª–æ–≤.\n\n"
    "üîÆ **–ö–∞–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–≤–æ–π –æ—Ç–≤–µ—Ç:**\n"
    "- –û–ø–∏—à–∏, –∫–∞–∫–∏–µ –∫–∞—Ä—Ç—ã –≤—ã–ø–∞–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–í–∞–º –≤—ã–ø–∞–ª –ê—Ä–∫–∞–Ω ‚Äò–°—É–¥‚Äô –≤ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏‚Ä¶¬ª).\n"
    "- –û–±—ä—è—Å–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ä—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.\n"
    "- –û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ –∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –æ –ø—Ä–æ—à–ª–æ–º, –Ω–∞—Å—Ç–æ—è—â–µ–º –∏ –±—É–¥—É—â–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏.\n"
    "- –î–∞–π –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã —á–µ–ª–æ–≤–µ–∫—É, –∏—Å—Ö–æ–¥—è –∏–∑ –∫–∞—Ä—Ç.\n"
    "- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–π—Ç–∏ —Å —Ä–∞–±–æ—Ç—ã –∏–ª–∏ –æ—Å—Ç–∞—Ç—å—Å—è), —É–∫–∞–∂–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.\n"
    "- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π **–º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —É–≤–µ—Ä–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞**.\n"
    "- –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π —Å–æ–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏ (–±–µ–∑ ¬´1.¬ª –∏–ª–∏ ¬´-¬ª), –Ω–µ –¥–∞–≤–∞–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–æ–≤ –∏ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π ¬´–æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞ –≤–∞–º–∏¬ª.\n\n"
    "–ï—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è, –ø–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏, "
    "—É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ –∑–∞–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –¥–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑.\n\n"
    "–£—á—Ç–∏, —á—Ç–æ —ç—Ç–æ ‚Äî –¥–∏–∞–ª–æ–≥. –§–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –±–µ—Å–µ–¥—ã, –Ω–æ –∏–∑–±–µ–≥–∞–π –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤. "
    "–ü–∏—à–∏ –≤ –æ–¥–Ω–æ–º –ø–æ—Ç–æ–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–π –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã.\n\n"
    "–î–∏–∞–ª–æ–≥:\n"
)


    try:
        response = gemini_client.models.generate_content(
            model="gemini-2.0-flash-exp",
            contents=system_prompt
        )

        if hasattr(response, 'text') and response.text:
            answer = response.text.strip()
        else:
            answer = "–Ø –Ω–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

        bot.send_message(user_id, f"üîÆ –û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞:\n\n{answer}")

        # **–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏–∞–ª–æ–≥–∞**
        conversation_context[user_id] = [{"role": "user", "content": query_text}]

        markup = telebot.types.InlineKeyboardMarkup()
        start_dialog_button = telebot.types.InlineKeyboardButton(text="–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥", callback_data="start_dialog")
        markup.add(start_dialog_button)
        bot.send_message(user_id, "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥ —Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.", reply_markup=markup)

    except Exception as e:
        logging.exception(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini: {str(e)}")
        bot.send_message(user_id, "üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    del user_queries[user_id]

# ========= –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥" =========
@bot.callback_query_handler(func=lambda call: call.data == "start_dialog")
def start_dialog_handler(call):
    user_id = call.message.chat.id
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π)
    if user_id not in conversation_context:
        conversation_context[user_id] = []  # –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    logging.info(f"–î–∏–∞–ª–æ–≥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –∑–∞–ø—É—â–µ–Ω. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.")
    
    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–≤–µ—Å—Ç–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
    markup = telebot.types.InlineKeyboardMarkup()
    end_dialog_button = telebot.types.InlineKeyboardButton(text="–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥", callback_data="end_dialog")
    markup.add(end_dialog_button)
    bot.send_message(user_id,
                     "–î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. "
                     "–ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
                     reply_markup=markup)

# ========= –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞ =========
@bot.message_handler(func=lambda message: message.chat.id in conversation_context and message.content_type == 'text')
def dialogue_message_handler(message):
    user_id = message.chat.id
    user_msg = message.text.strip()
    
    logging.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {user_msg}")
    
    if not user_msg:
        bot.send_message(user_id, "‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç.")
        return

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    conversation_context[user_id].append({"role": "user", "content": user_msg})

    base_prompt = (
    "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≥–∞–¥–∞–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–∞—Ö –¢–∞—Ä–æ. "
    "–¢—ã —Ç–æ–ª–∫—É–µ—à—å –∫–∞—Ä—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É—è —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã –∏ –≥–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è —ç–∑–æ—Ç–µ—Ä–∏–∫–∏. "
    "–ì–æ–≤–æ—Ä–∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ, —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø—Ä–æ —Å–≤–æ–±–æ–¥—É –≤–æ–ª–∏ –∏–ª–∏ —Ç–æ, —á—Ç–æ –∏—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. "
    "–ü–∏—à–∏, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –º–∏—Å—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —É–≤–µ—Ä–µ–Ω –≤ –ø—Ä–∞–≤–¥–∏–≤–æ—Å—Ç–∏ —Å–≤–æ–∏—Ö —Å–ª–æ–≤.\n\n"
    "üîÆ **–ö–∞–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–≤–æ–π –æ—Ç–≤–µ—Ç:**\n"
    "- –û–ø–∏—à–∏, –∫–∞–∫–∏–µ –∫–∞—Ä—Ç—ã –≤—ã–ø–∞–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–í–∞–º –≤—ã–ø–∞–ª –ê—Ä–∫–∞–Ω ‚Äò–°—É–¥‚Äô –≤ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏‚Ä¶¬ª).\n"
    "- –û–±—ä—è—Å–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ä—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.\n"
    "- –û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ –∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –æ –ø—Ä–æ—à–ª–æ–º, –Ω–∞—Å—Ç–æ—è—â–µ–º –∏ –±—É–¥—É—â–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏.\n"
    "- –î–∞–π –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã —á–µ–ª–æ–≤–µ–∫—É, –∏—Å—Ö–æ–¥—è –∏–∑ –∫–∞—Ä—Ç.\n"
    "- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–π—Ç–∏ —Å —Ä–∞–±–æ—Ç—ã –∏–ª–∏ –æ—Å—Ç–∞—Ç—å—Å—è), —É–∫–∞–∂–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.\n"
    "- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π **–º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —É–≤–µ—Ä–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞**.\n"
    "- –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π —Å–æ–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏ (–±–µ–∑ ¬´1.¬ª –∏–ª–∏ ¬´-¬ª), –Ω–µ –¥–∞–≤–∞–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–æ–≤ –∏ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π ¬´–æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞ –≤–∞–º–∏¬ª.\n\n"
    "–ï—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è, –ø–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏, "
    "—É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ –∑–∞–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –¥–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑.\n\n"
    "–£—á—Ç–∏, —á—Ç–æ —ç—Ç–æ ‚Äî –¥–∏–∞–ª–æ–≥. –§–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –±–µ—Å–µ–¥—ã, –Ω–æ –∏–∑–±–µ–≥–∞–π –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤. "
    "–ü–∏—à–∏ –≤ –æ–¥–Ω–æ–º –ø–æ—Ç–æ–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–π –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã.\n\n"
    "–î–∏–∞–ª–æ–≥:\n"
)


    # –°–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    dialogue_history = ""
    for msg in conversation_context[user_id]:
        if msg["role"] == "user":
            dialogue_history += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {msg['content']}\n"
        else:
            dialogue_history += f"–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: {msg['content']}\n"

    full_prompt = base_prompt + dialogue_history

    bot.send_chat_action(user_id, action='typing')

    try:
        response = gemini_client.models.generate_content(
            model="gemini-2.0-flash-exp",
            contents=full_prompt
        )

        if hasattr(response, 'text') and response.text:
            answer = response.text.strip()
        else:
            answer = "–Ø –Ω–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
        conversation_context[user_id].append({"role": "assistant", "content": answer})
        logging.info(f"–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {answer}")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤–º–µ—Å—Ç–µ —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
        markup = telebot.types.InlineKeyboardMarkup()
        end_dialog_button = telebot.types.InlineKeyboardButton(text="–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥", callback_data="end_dialog")
        markup.add(end_dialog_button)
        bot.send_message(user_id, f"üîÆ –û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞:\n\n{answer}", reply_markup=markup)

    except Exception as e:
        logging.exception(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞: {str(e)}")
        bot.send_message(user_id, "üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# ========= –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥" =========
@bot.callback_query_handler(func=lambda call: call.data == "end_dialog")
def end_dialog_handler(call):
    user_id = call.message.chat.id
    if user_id in conversation_context:
        del conversation_context[user_id]
        logging.info(f"–î–∏–∞–ª–æ–≥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –∑–∞–≤–µ—Ä—à—ë–Ω –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É–¥–∞–ª—ë–Ω.")
    bot.send_message(user_id, "–î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω. –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–º–æ—â—å, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.")


# üîπ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling(none_stop=True)



